---
title: jest单元测试
date: 2019-11-27
categories:
- jest
tags:
- jest
- unit
- vue
- Learning
---

补项目的单元测试补到要吐了，真心烦 = =

才刚刚在项目执行`npm run unit`就翻车了。(╯‵□′)╯︵┻━┻

### 问题

#### 1. Option "mapCoverage" has been removed, as it's no longer necessary.

详细信息：

```bash
 Option "mapCoverage" has been removed, as it's no longer necessary.
 Please update your configuration.
 Configuration Documentation:
 https://facebook.github.io/jest/docs/configuration.html
```
解决方法：
在配置文件jest.conf.js中删除`mapCoverage`




#### 2. SecurityError: localStorage is not available for opaque origins

详细信息：

```bash
SecurityError: localStorage is not available for opaque origins
at Window.get localStorage [as localStorage] (node_modules/jsdom/lib/jsdom/browser/Window.js:257:15)
at Array.forEach (<anonymous>)
```
解决方法：

修改 jest.conf.js 文件添加一行`testURL`

```javascript
const path = require('path')

module.exports = {
  rootDir: path.resolve(__dirname, '../../'),
  moduleFileExtensions: [
    'js',
    'json',
    'vue'
  ],
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1'
  },
  transform: {
    '^.+\\.js$': '<rootDir>/node_modules/babel-jest',
    '.*\\.(vue)$': '<rootDir>/node_modules/vue-jest'
  },
  testPathIgnorePatterns: [
    '<rootDir>/test/e2e'
  ],
  snapshotSerializers: ['<rootDir>/node_modules/jest-serializer-vue'],
  setupFiles: ['<rootDir>/test/unit/setup'],
  coverageDirectory: '<rootDir>/test/unit/coverage',
  collectCoverageFrom: [
    'src/**/*.{js,vue}',
    '!src/main.js',
    '!src/router/index.js',
    '!**/node_modules/**'
  ],
	'testURL': 'http://localhost'
}
```

参考资料：

https://blog.csdn.net/yj1499945/article/details/88988628



#### 3.Test suite failed to run

详细信息：
```bash
  ● Test suite failed to run

    Your test suite must contain at least one test.
    
    ......
```
解决方法：
测试文件不能为空，只要有一个测试方法。



#### 4.Uncaught TypeError: Cannot read property 'getters' of undefined
详细信息：

```bash
Uncaught TypeError: Cannot read property 'getters' of undefined
```

解决方法：
如下参考资料

参考资料：
[Uncaught TypeError: Cannot read property 'getters' of undefined](https://www.cnblogs.com/ccgyyn/p/10544965.html)



### Jest配置文件

jest.conf.js 配置文件

```js
const path = require('path')

module.exports = {
  rootDir: path.resolve(__dirname, '../../'),
  moduleFileExtensions: [
    'js',
    'json',
    'vue'
  ],
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1'
  },
  transform: {
    '^.+\\.js$': '<rootDir>/node_modules/babel-jest',
    '.*\\.(vue)$': '<rootDir>/node_modules/vue-jest'
  },
  testPathIgnorePatterns: [
    '<rootDir>/test/e2e'
  ],
  snapshotSerializers: ['<rootDir>/node_modules/jest-serializer-vue'],
  setupFiles: ['<rootDir>/test/unit/setup'],
  coverageDirectory: '<rootDir>/test/unit/coverage',
  // jest 覆盖的文件
  collectCoverageFrom: [
    //'src/**/*.{js,vue}',
    'src/**/*.js',
    '!src/main.js',
    '!src/router/index.js',
    '!src/store/index.js',
    '!src/mock/*.js',
    '!**/node_modules/**'
  ],
  // 全局变量的定义
  globals: {
    baseUrl: 'http://intranet.cityworks.cn:88/cloud-gateway/manage-server',
    urlPreview: 'http://intranet.cityworks.cn:88/cloud-gateway/preview',
    exportUrl: 'http://intranet.cityworks.cn:88/cloud-gateway/export',
    pagePreUrl: 'http://intranet.cityworks.cn:88/cloud-gateway/export',
    monitorUrl: 'http://10.99.85.174:9123'
  },
  verbose: true,
  // 忽略的文件
  coveragePathIgnorePatterns: ["node_modules", 'iconfont.js', 'request.js', 'rightMenu.js'],
  testURL: 'http://localhost'
}

```

setup.js 环境配置文件

```js
import Vue from 'vue'
import store from "../../src/store";
import ElementUI from 'element-ui';
import '../../src/mock/index.js'

Vue.config.productionTip = false;

Vue.use(ElementUI);

new Vue({
  store,
});

// 全局函数配置
global.console = {
  log: jest.fn(),
  error: jest.fn(),
  warn: jest.fn(),
  info: jest.fn(),
  debug: jest.fn(),
};

const Message = jest.fn();

sessionStorage.setItem('username', 'test');

// 响应时间配置
jest.setTimeout(40000);

```

