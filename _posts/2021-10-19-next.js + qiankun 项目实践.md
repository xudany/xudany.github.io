---
title: next.js + qiankun é¡¹ç›®å®è·µ
date: 2021-10-19
categories:
- å¾®å‰ç«¯
tags:
- å¾®å‰ç«¯
- next.js
- qiankun
---

æ‰“ç®—åœ¨ next.js é¡¹ç›®ä¸­é›†æˆ qiankun è¿™ä¸ªå¾®å‰ç«¯æ¡†æ¶äº†ã€‚â•®(ï¿£â–½ï¿£)â•­

## qiankun

æŒ‰ç…§æƒ¯ä¾‹ï¼Œå…ˆè¯´è¯´å•¥æ˜¯ qiankun

> qiankun æ˜¯ä¸€ä¸ªåŸºäº single-spa çš„å¾®å‰ç«¯å®ç°åº“ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶èƒ½æ›´ç®€å•ã€æ— ç—›çš„æ„å»ºä¸€ä¸ªç”Ÿäº§å¯ç”¨å¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚

qiankun çš„ç‰¹æ€§

-  **åŸºäº [single-spa](https://github.com/CanopyTax/single-spa)** å°è£…ï¼Œæä¾›äº†æ›´åŠ å¼€ç®±å³ç”¨çš„ APIã€‚
-  **æŠ€æœ¯æ ˆæ— å…³**ï¼Œä»»æ„æŠ€æœ¯æ ˆçš„åº”ç”¨å‡å¯ ä½¿ç”¨/æ¥å…¥
-  **HTML Entry æ¥å…¥æ–¹å¼**
-  **æ ·å¼éš”ç¦»**ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´æ ·å¼äº’ç›¸ä¸å¹²æ‰°ã€‚
-  **JS æ²™ç®±**ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´ å…¨å±€å˜é‡/äº‹ä»¶ ä¸å†²çªã€‚
-  **èµ„æºé¢„åŠ è½½**
- æä¾› **umi æ’ä»¶**

æ›´å¤šçš„ä¿¡æ¯å°±å‡ºé—¨å³è½¬ [qiankunå®˜ç½‘](https://qiankun.umijs.org/)



## ä¸ºä»€ä¹ˆç”¨qiankun

å…¶å® next.js æœ¬èº«å°±å…·å¤‡ä¸€å®šå¾®å‰ç«¯çš„èƒ½åŠ›ï¼Œåœ¨ next.config.js ä¸­æä¾›äº† rewrites é…ç½®ï¼Œå¯ä»¥å°†å‰ç«¯è·¯ç”±è¯·æ±‚ä»£ç†åˆ°å¦å¤–ä¸€å° next.js æœåŠ¡å™¨ï¼ŒåŒæ—¶ä¿æŒå‰ç«¯è·¯ç”±çŠ¶æ€ã€‚

é‚£ä¸ºä»€ä¹ˆè¿˜è¦ç”¨qiankunï¼Ÿæœ€ä¸»è¦æ˜¯å› ä¸º nextjs å¾®æœåŠ¡æ¶æ„å¯¹å­åº”ç”¨çš„æŠ€æœ¯æ ˆæœ‰é™åˆ¶ï¼Œè¦å®ç°å¾®å‰ç«¯ï¼Œæ‰€æœ‰çš„å­åº”ç”¨éƒ½åº”è¯¥ä½¿ç”¨ nextjsï¼Œæ‰€ä»¥ä¸é€‚åˆâ€œèƒ½å¤Ÿå¼•å…¥ä¸åŒæŠ€æœ¯æ ˆçš„å‰ç«¯é¡¹ç›®éœ€æ±‚ã€‚

æ›´å¤š next.js å¾®å‰ç«¯ç›¸å…³å¯çœ‹ [nextjså¾®æœåŠ¡åŸç†](https://zhuanlan.zhihu.com/p/362664179)



## å®ç°åŠŸèƒ½

1. ä¸å½±å“åŸé¡¹ç›®çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿå¼•å…¥ä¸åŒæŠ€æœ¯æ ˆçš„å‰ç«¯é¡¹ç›®

2. æ•°æ®å…±äº«

3. é€šç”¨æ–¹æ³•ã€å·¥å…·ç±»ç­‰å…±äº«

   ......å¾…è¡¥å……......



## é¡¹ç›®æ¶æ„

å…¶ä»–å¾ˆå¤š qiankun é¡¹ç›®å®è·µä¸­â€œä¸€ä¸ªåŸºåº§åº”ç”¨ï¼Œè‹¥å¹²ä¸ªå¾®åº”ç”¨â€çš„é¡¹ç›®ç»“æ„ï¼Œä½†æˆ‘å› ä¸ºæ˜¯è¦åœ¨åŸæœ‰çš„ next.js é¡¹ç›®åŸºç¡€ä¸Šå¼•å…¥qiankunï¼Œä½¿å…¶å…·æœ‰å…¼å®¹å…¶ä»–å‰ç«¯é¡¹ç›®çš„èƒ½åŠ›ï¼Œä½†æ˜¯ä¸å½±å“é¡¹ç›®åŸæœ‰çš„åŠŸèƒ½ï¼Œæ‰€ä»¥äºæˆ‘çš„é¡¹ç›®è€Œè¨€ï¼Œâ€œåŸºåº§â€å’ŒåŸ next.js çš„é¡¹ç›®å¯èƒ½æ›´åƒæ˜¯â€œä¸»ä»â€å…³ç³»ï¼Ÿå¯ä»¥è¯´â€œåŸºåº§â€æ˜¯åŸé¡¹ç›®æä¾›å‡ºæ¥çš„ä¸€ç§èƒ½åŠ›ã€‚

å¤§è‡´çš„æ¶æ„å›¾å¦‚ä¸‹ï¼š

![é¡¹ç›®æ¶æ„.jpg](/assets/images/2021-10-19/2021-10-19-01.jpg)



## åŸºåº§é…ç½®

åœ¨ä¸»åº”ç”¨ä¸­å®‰è£… qiankun

```bash
$ yarn add qiankun # æˆ–è€… npm i qiankun -S
```

æŠŠåŸºåº§å°è£…æˆä¸€ä¸ªç»„ä»¶ï¼Œå½“æˆç»„ä»¶æ¥ä½¿ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å› ä¸ºæœ‰æœåŠ¡ç«¯æ¸²æŸ“ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ `window undefined` çš„é—®é¢˜ï¼Œæ‰€ä»¥ qiankun çš„å¼•ç”¨éœ€è¦åœ¨useEffectä¸­æ‰å¯ä»¥ã€‚

åœ¨ä¸»åº”ç”¨ä¸­æ³¨å†Œå¾®åº”ç”¨ï¼Œå¤§æ¦‚å°±æ˜¯å¦‚ä¸‹ï¼š 

```tsx
import React, { useEffect } from 'react';
import OSBasePage from 'components/pages/BasePage/OSBasePage';

const Micro = () => {
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const {
        registerMicroApps,
        start,
      } = require('qiankun');

      registerMicroApps(
        [
          {
            name: 'react',
            entry: '//localhost:3001',
            container: '#Micro',
            activeRule: '/micro/react',
          },
        ],
      );

      start();
    }
  }, []);

  return (
    <OSBasePage>
      <div id="Micro" />
    </OSBasePage>
  );
};

export default Micro;

```

å¯¹äºå¾®åº”ç”¨çš„æ³¨å†Œå¯ä»¥æŠ½å–å‡ºæ¥ï¼Œåé¢é€šè¿‡è¯·æ±‚æ¥å®ç°å¾®åº”ç”¨çš„åŠ¨æ€æ³¨å†Œã€‚



## å¾®åº”ç”¨é…ç½®

å¾®åº”ç”¨ä¸éœ€è¦é¢å¤–å®‰è£…ä»»ä½•å…¶ä»–ä¾èµ–å³å¯æ¥å…¥ qiankun ä¸»åº”ç”¨ã€‚

å¾®åº”ç”¨åˆ†ä¸ºæœ‰ `webpack` æ„å»ºå’Œæ—  `webpack` æ„å»ºé¡¹ç›®ï¼Œæœ‰ `webpack` çš„å¾®åº”ç”¨ï¼ˆä¸»è¦æ˜¯æŒ‡ Vueã€Reactã€Angularï¼‰éœ€è¦åšçš„äº‹æƒ…æœ‰ï¼š

1. æ–°å¢ `public-path.js` æ–‡ä»¶ï¼Œç”¨äºä¿®æ”¹è¿è¡Œæ—¶çš„ `publicPath`ã€‚[ä»€ä¹ˆæ˜¯è¿è¡Œæ—¶çš„ publicPath ï¼Ÿ](https://webpack.docschina.org/guides/public-path/#on-the-fly)ã€‚

æ³¨æ„ï¼šè¿è¡Œæ—¶çš„ publicPath å’Œæ„å»ºæ—¶çš„ publicPath æ˜¯ä¸åŒçš„ï¼Œä¸¤è€…ä¸èƒ½ç­‰ä»·æ›¿ä»£ã€‚

1. å¾®åº”ç”¨å»ºè®®ä½¿ç”¨ `history` æ¨¡å¼çš„è·¯ç”±ï¼Œéœ€è¦è®¾ç½®è·¯ç”± `base`ï¼Œå€¼å’Œå®ƒçš„ `activeRule` æ˜¯ä¸€æ ·çš„ã€‚
2. åœ¨å…¥å£æ–‡ä»¶æœ€é¡¶éƒ¨å¼•å…¥ `public-path.js`ï¼Œä¿®æ”¹å¹¶å¯¼å‡ºä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚
3. ä¿®æ”¹ `webpack` æ‰“åŒ…ï¼Œå…è®¸å¼€å‘ç¯å¢ƒè·¨åŸŸå’Œ `umd` æ‰“åŒ…ã€‚

æ—  `webpack` æ„å»ºçš„å¾®åº”ç”¨ç›´æ¥å°† `lifecycles` æŒ‚è½½åˆ° `window` ä¸Šå³å¯ã€‚

### react å­åº”ç”¨

ä»¥ `create react app` ç”Ÿæˆçš„ `react 17` é¡¹ç›®ä¸ºä¾‹ï¼Œæ­é… `react-router-dom` 5.xã€‚

1. åœ¨ `src` ç›®å½•æ–°å¢ `public-path.js`ï¼š

```js
if (window.__POWERED_BY_QIANKUN__) {
	// eslint-disable-next-line
__webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}
```

2. è®¾ç½® `history` æ¨¡å¼è·¯ç”±çš„ `base`ï¼š

```html
<BrowserRouter basename={window.__POWERED_BY_QIANKUN__ ? '/app-react' : '/'}>
```

3. å…¥å£æ–‡ä»¶ `index.js` ä¿®æ”¹ï¼Œä¸ºäº†é¿å…æ ¹ id `#root` ä¸å…¶ä»–çš„ DOM å†²çªï¼Œéœ€è¦é™åˆ¶æŸ¥æ‰¾èŒƒå›´ã€‚

```js
import './public-path';
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';


function render(props) {
const { container } = props;
ReactDOM.render(<App />, container ? container.querySelector('#root') : document.querySelector('#root'));
}


if (!window.__POWERED_BY_QIANKUN__) {
render({});
}


export async function bootstrap() {
console.log('[react17] react app bootstraped');
}


export async function mount(props) {
console.log('[react17] props from main framework', props);
render(props);
}


export async function unmount(props) {
const { container } = props;
ReactDOM.unmountComponentAtNode(container ? container.querySelector('#root') : document.querySelector('#root'));
}
```

å¦‚æœç”¨çš„æ˜¯ react typescript çš„æ¨¡æ¿ï¼Œåˆ™ä¿®æ”¹`index.tsx`æ–‡ä»¶ä¸º

```tsx
// public-pathå¿…é¡»åœ¨æœ€ä¸Šé¢ï¼Œä¸ç„¶å›¾ç‰‡è·¯å¾„ä¼šæŠ¥é”™
import './public-path.js'
import React from 'react';
import ReactDOM from 'react-dom';
import './index.css';
import App from './App';
import reportWebVitals from './reportWebVitals';

declare global {
    interface Window {
        __POWERED_BY_QIANKUN__: string
    }
}

function render(props: any) {
    const {container} = props;
    ReactDOM.render(<App/>, container ? container.querySelector('#root') : document.querySelector('#root'));
}

if (!window.__POWERED_BY_QIANKUN__) {
    render({});
}

export async function bootstrap() {
    console.log('[react17] react app bootstraped');
}

export async function mount(props: any) {
    console.log('[react17] props from main framework', props);
    render(props);
}

export async function unmount(props: any) {
    const {container} = props;
    ReactDOM.unmountComponentAtNode(container ? container.querySelector('#root') : document.querySelector('#root'));
}

reportWebVitals();
```

4. ä¿®æ”¹ `webpack` é…ç½®

å®‰è£…æ’ä»¶ `@rescripts/cli`ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©å…¶ä»–çš„æ’ä»¶ï¼Œä¾‹å¦‚ `react-app-rewired`ã€‚

```dash
yarn add -D @rescripts/cli
```

æ ¹ç›®å½•æ–°å¢ `.rescriptsrc.js`ï¼š

```js
const { name } = require('./package');

module.exports = {
  webpack: (config) => {
    config.output.library = `${name}-[name]`;
    config.output.libraryTarget = 'umd';
    config.output.jsonpFunction = `webpackJsonp_${name}`;
    config.output.globalObject = 'window';

    return config;
  },

  devServer: (_) => {
    const config = _;

    config.headers = {
      'Access-Control-Allow-Origin': '*',
    };
    config.historyApiFallback = true;
    config.hot = false;
    config.watchContentBase = false;
    config.liveReload = false;

    return config;
  },
};
```

ä¿®æ”¹ `package.json`ï¼š

```diff
-   "start": "react-scripts start",
+   "start": "rescripts start",
-   "build": "react-scripts build",
+   "build": "rescripts build",
-   "test": "react-scripts test",
+   "test": "rescripts test",
-   "eject": "react-scripts eject"
```

å¦‚æœç”¨çš„æ˜¯`react-app-rewired`ï¼Œåˆ™

```dash
yarn add -D react-app-rewired
```

æ ¹ç›®å½•æ–°å¢ `config-overrides.js`ï¼š

```js
const { name } = require('./package.json');

module.exports = {
  webpack: function override(config) {
    config.output.library = `${name}-[name]`;
    config.output.libraryTarget = 'umd';
    config.output.jsonpFunction = `webpackJsonp_${name}`;
    config.output.globalObject = 'window';

    return config;
  },

  devServer: (configFunction) => {
    return function (proxy, allowedHost) {
      const config = configFunction(proxy, allowedHost);
      config.open = false;
      config.hot = false;
      config.headers = {
        'Access-Control-Allow-Origin': '*',
      };
      return config;
    };
  },
};
```

ä¿®æ”¹ `package.json`ï¼š

```diff
  "scripts": {
-   "start": "react-scripts start",
+   "start": "react-app-rewired start",
-   "build": "react-scripts build",
+   "build": "react-app-rewired build",
-   "test": "react-scripts test",
+   "test": "react-app-rewired test",
    "eject": "react-scripts eject"
}
```

å¦‚æœç”¨çš„æ˜¯`run eject`å¼¹å‡ºwebpacké…ç½®çš„æ–¹å¼ï¼Œé‚£ä¹ˆåœ¨ `config/webpackDevServer.config.js` ä¸­é…ç½®ï¼š

```js
module.exports = function(proxy, allowedHost) {
  return {
    hot: false,
    headers: {
      "Access-Control-Allow-Origin": "*",
    },
    watchContentBase: false,
    liveReload: false
  }
}
```

åœ¨`config/webpack.config.js`ä¸­é…ç½®ï¼š

```js
const packageName = require('./package.json').name;

module.exports = function(webpackEnv) {
  return {
    output: {
      library: `${packageName}-[name]`,
      libraryTarget: 'umd',
      jsonpFunction: `webpackJsonp_${packageName}`,
    }
  }
}
```

åˆ°è¿™é‡Œï¼Œreact çš„é…ç½®å°±ç®—å®Œæˆäº†ã€‚



### vue å­åº”ç”¨

ä»¥ `vue-cli 3+` ç”Ÿæˆçš„ `vue 2.x` é¡¹ç›®ä¸ºä¾‹ã€‚

1. åœ¨ `src` ç›®å½•æ–°å¢ `public-path.js`ï¼š

```js
if (window.__POWERED_BY_QIANKUN__) {
  // eslint-disable-next-line
  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}
```

2. å…¥å£æ–‡ä»¶ `main.js` ä¿®æ”¹ï¼Œä¸ºäº†é¿å…æ ¹ id `#app` ä¸å…¶ä»–çš„ DOM å†²çªï¼Œéœ€è¦é™åˆ¶æŸ¥æ‰¾èŒƒå›´ã€‚

```js
import './public-path';
import Vue from 'vue';
import VueRouter from 'vue-router';
import App from './App.vue';
import routes from './router';
import store from './store';

Vue.config.productionTip = false;

let router = null;
let instance = null;
function render(props = {}) {
  const { container } = props;
  router = new VueRouter({
    base: window.__POWERED_BY_QIANKUN__ ? '/app-vue/' : '/',
    mode: 'history',
    routes,
  });

  instance = new Vue({
    router,
    store,
    render: (h) => h(App),
  }).$mount(container ? container.querySelector('#app') : '#app');
}

// ç‹¬ç«‹è¿è¡Œæ—¶
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}

export async function bootstrap() {
  console.log('[vue] vue app bootstraped');
}
export async function mount(props) {
  console.log('[vue] props from main framework', props);
  render(props);
}
export async function unmount() {
  instance.$destroy();
  instance.$el.innerHTML = '';
  instance = null;
  router = null;
}
```

3. åœ¨æ ¹ç›®å½•åˆ›å»º`vue.config.js`æ–‡ä»¶ï¼Œç”¨æ¥ä¿®æ”¹æ‰“åŒ…é…ç½®ï¼š

```js
const { name } = require('./package');
module.exports = {
  devServer: {
    headers: {
      'Access-Control-Allow-Origin': '*',
    },
  },
  configureWebpack: {
    output: {
      library: `${name}-[name]`,
      libraryTarget: 'umd', // æŠŠå¾®åº”ç”¨æ‰“åŒ…æˆ umd åº“æ ¼å¼
      jsonpFunction: `webpackJsonp_${name}`,
    },
  },
};
```



ä»¥`vue-cli 2`ç”Ÿæˆçš„`vue 2.x`é¡¹ç›®ä¸ºä¾‹

1. åœ¨ `src` ç›®å½•æ–°å¢ `public-path.js`ï¼š

```js
if (window.__POWERED_BY_QIANKUN__) {
  // eslint-disable-next-line
  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}
```

2. å…¥å£æ–‡ä»¶ `main.js` ä¿®æ”¹ï¼Œä¸ºäº†é¿å…æ ¹ id `#app` ä¸å…¶ä»–çš„ DOM å†²çªï¼Œéœ€è¦é™åˆ¶æŸ¥æ‰¾èŒƒå›´ã€‚

```js
import './public-path.js'
import Vue from 'vue'
import App from './App'
import router from './router'

Vue.config.productionTip = false

let instance = null
function render (props = {}) {
  const { container } = props

  instance = new Vue({
    router,
    store,
    render: (h) => h(App)
  }).$mount(container ? container.querySelector('#app') : '#app')
}

// ç‹¬ç«‹è¿è¡Œæ—¶
if (!window.__POWERED_BY_QIANKUN__) {
  render()
}

export async function bootstrap () {
  console.log('[vue] vue app bootstraped')
}
export async function mount (props) {
  console.log('[vue] props from main framework', props)
  render(props)
}
export async function unmount () {
  instance.$destroy()
  instance.$el.innerHTML = ''
  instance = null
}
```

ä¿®æ”¹`router`æ–‡ä»¶

```js
import '../public-path.js'
import Vue from 'vue'
import Router from 'vue-router'
import HelloWorld from '@/components/HelloWorld'

Vue.use(Router)

export default new Router({
  base: window.__POWERED_BY_QIANKUN__ ? '/micro/app-vue/' : '/',
  mode: 'history',
  routes: [
    {
      path: '/',
      name: 'HelloWorld',
      component: HelloWorld
    }
  ]
})
```

3. ä¿®æ”¹webpacké…ç½®ï¼Œå½“vue.config.jsæ²¡æœ‰ç”Ÿæ•ˆçš„æ—¶å€™ï¼Œé€‰æ‹©è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹ï¼š

ä¿®æ”¹`build/webpack.dev.conf.js`

```js
  devServer: {
    ......
    headers: {
      'Access-Control-Allow-Origin': '*',
    },
  },
```

ä¿®æ”¹`build/webpack.base.conf.js`

```js
const { name } = require('./package');
module.exports = {
  output: {
    library: `${name}-[name]`,
    libraryTarget: 'umd', // æŠŠå¾®åº”ç”¨æ‰“åŒ…æˆ umd åº“æ ¼å¼
    jsonpFunction: `webpackJsonp_${name}`,
    ......
  },
}
```



åŸºç¡€ç‰ˆæœ¬çš„vueå­åº”ç”¨é…ç½®å¥½äº†ï¼Œå¦‚æœ`router`å’Œ`vuex`ä¸éœ€ç”¨åˆ°ï¼Œå¯ä»¥é€‰æ‹©æ€§å»æ‰ã€‚



## æ•°æ®å…±äº«





## é€šç”¨æ–¹æ³•ã€å·¥å…·ç±»ç­‰å…±äº«

æœ‰äº›æ–¹æ³•æˆ–å·¥å…·ç±»æ˜¯æ‰€æœ‰å­åº”ç”¨éƒ½éœ€è¦ç”¨åˆ°çš„ï¼Œè§£å†³èµ„æºå…±ç”¨çš„é—®é¢˜ï¼Œå¯ä»¥æé«˜é¡¹ç›®çš„ç»´æŠ¤æ€§,ä¸ç„¶å¤šä¸ªç³»ç»Ÿå…±ç”¨çš„ç»„ä»¶æˆ–è€…å·¥å…·ç»´æŠ¤èµ·æ¥å¾ˆè´¹åŠ›ï¼Œæ‰€ä»¥æŠ½å–å…¬å…±ä»£ç åˆ°ä¸€å¤„æ˜¯å¿…è¦çš„ä¸€æ­¥ã€‚è¦è®©å­åº”ç”¨èƒ½å¤Ÿä½¿ç”¨å…¬å…±ä»£ç ï¼Œéœ€è¦è®©è¿™äº›å…¬å…±æ–¹æ³•ï¼Œå·¥å…·ç±»å‘å¸ƒæˆä¸€ä¸ªnpmç§æœ‰åŒ…ã€‚

å‘å¸ƒä¸ºä¸€ä¸ªnpmç§åŒ…ï¼Œnpmç§åŒ…æœ‰ä»¥ä¸‹å‡ ç§ç»„ç»‡å½¢å¼ï¼š

- npmæŒ‡å‘æœ¬åœ°fileåœ°å€ï¼š`npm install file:../common`ã€‚ç›´æ¥åœ¨æ ¹ç›®å½•æ–°å»ºä¸€ä¸ªcommonç›®å½•ï¼Œç„¶ånpmç›´æ¥ä¾èµ–æ–‡ä»¶è·¯å¾„ã€‚
- npmæŒ‡å‘ç§æœ‰gitä»“åº“: `npm install git+ssh://xxx-common.git`ã€‚
- å‘å¸ƒåˆ°npmç§æœã€‚

è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯ç”¨gitåº“å¼•å…¥, åœ¨package.jsonçš„ä¾èµ–ä¸­åŠ å…¥"qiankun-common":"git+https://git@github.com:czero1995/qiankun-common.git"




## é‡åˆ°çš„é—®é¢˜

### TypeError: application 'react' died in status LOADING SOURCE CODE: Failed to fetch

è¿™ä¸ªé—®é¢˜å¯èƒ½æ˜¯ç½‘ç»œä¸é€šæˆ–è€…æ˜¯è·¨åŸŸè¢«é˜»æ­¢äº†ï¼Œå¦‚æœæ˜¯å¼€å‘ç¯å¢ƒï¼Œæ£€æŸ¥ä¸€ä¸‹å¾®åº”ç”¨æ˜¯å¦å·²å¯åŠ¨ï¼Œæ˜¯å¦åšäº†è·¨åŸŸè®¾ç½®ã€‚

webpack è·¨è¶Šè®¾ç½®ï¼Œåœ¨ `devServer` ä¸­è®¾ç½®å¤´éƒ¨ `headers` ä¸º `"Access-Control-Allow-Origin": "*"`

```js
module.exports = {
  devServer: (_) => {
    const config = _;

    // é‡ç‚¹
    config.headers = {
      'Access-Control-Allow-Origin': '*',
    };
    
    config.historyApiFallback = true;
    config.hot = false;
    config.watchContentBase = false;
    config.liveReload = false;

    return config;
  },
};
```

æˆ–è€…æ˜¯å¾®åº”ç”¨å¼•å…¥äº†ç¬¬ä¸‰æ–¹é™æ€èµ„æºæ—¶è·¨åŸŸå¯¼è‡´

è§£å†³å‚è€ƒï¼š

[Uncaught TypeError: application 'sub-app' died in status LOADING_SOURCE_CODE: Failed to fetch #1331]( https://github.com/umijs/qiankun/issues/1331)

[ å¾®åº”ç”¨é™æ€èµ„æºä¸€å®šè¦æ”¯æŒè·¨åŸŸå—ï¼Ÿ](https://qiankun.umijs.org/zh/faq#%E5%BE%AE%E5%BA%94%E7%94%A8%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E4%B8%80%E5%AE%9A%E8%A6%81%E6%94%AF%E6%8C%81%E8%B7%A8%E5%9F%9F%E5%90%97)




### Error: application 'react' died in status LOADING_SOURCE_CODE: [qiankun]: You need to export lifecycle functions in react entry

qiankun æŠ›å‡ºè¿™ä¸ªé”™è¯¯æ˜¯å› ä¸ºæ— æ³•ä»å¾®åº”ç”¨çš„ entry js ä¸­è¯†åˆ«å‡ºå…¶å¯¼å‡ºçš„ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚

æ£€æŸ¥å¾®åº”ç”¨æ˜¯å¦å·²ç»å¯¼å‡ºç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚æ£€æŸ¥å¾®åº”ç”¨çš„ webpack æ˜¯å¦å¢åŠ äº†æŒ‡å®šçš„é…ç½®ã€‚å…¶ä»–ä¸€äº›è§£å†³æ–¹æ³•è§ qiankun å®˜ç½‘æ–‡æ¡£ã€‚

è§£å†³å‚è€ƒï¼š[Application died in status LOADING_SOURCE_CODE: You need to export the functional lifecycles in xxx entry](https://qiankun.umijs.org/zh/faq#application-died-in-status-loading_source_code-you-need-to-export-the-functional-lifecycles-in-xxx-entry)

è¿˜æœ‰ä¸€ç§æƒ…å†µä¹Ÿä¼šæŠ¥è¿™ä¸ªé”™ï¼Œå¾®åº”ç”¨ä¸ºreactï¼Œä¿®æ”¹å¾®åº”ç”¨ä¹‹åï¼Œä¸»åº”ç”¨æŠ¥é”™ï¼Œéœ€è¦å…³æ‰çƒ­é‡è½½ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯`react-scripts-rewired`ä¿®æ”¹webpacké…ç½®ï¼Œåˆ™æ”¹ï¼š

```js
const { name } = require('./package.json');

module.exports = {
  webpack: function override(config, env) {
    // é‡ç‚¹
    config.entry = config.entry.filter(
      (e) => !e.includes('webpackHotDevClient')
    );
    
    config.output.library = `${name}-[name]`;
    config.output.libraryTarget = 'umd';
    config.output.jsonpFunction = `webpackJsonp_${name}`;
    config.output.globalObject = 'window';
    
    return config;
  },
  devServer: (configFunction) => {
    return function (proxy, allowedHost) {
      const config = configFunction(proxy, allowedHost);
      config.open = false;
      config.hot = false;
      config.headers = {
        'Access-Control-Allow-Origin': '*',
      };
      return config;
    };
  },
};
```



è§£å†³å‚è€ƒï¼š[å­é¡¹ç›®ä¸ºcreate-react-appï¼Œä¿®æ”¹ä»»æ„å,ä¸»é¡¹ç›®æŠ¥é”™](https://github.com/umijs/qiankun/issues/340)



### ä¸»åº”ç”¨ä¸­çš„å¾®åº”ç”¨å›¾ç‰‡æˆ–è€…é™æ€èµ„æº404

åŸå› æ˜¯ webpack åŠ è½½èµ„æºæ—¶æœªä½¿ç”¨æ­£ç¡®çš„ publicPathã€‚

æˆ‘è‡ªå·±çš„åŸå› æ˜¯`entry`æ–‡ä»¶å¼•ç”¨`public-path.js`çš„æ—¶å€™æ²¡æœ‰ç½®äºæœ€å‰ã€‚å‚è€ƒä¸Šé¢reactå­åº”ç”¨çš„é…ç½®ã€‚

æˆ–è€…è‡ªå·±æ·»åŠ ç¯å¢ƒå˜é‡ä¿®æ”¹ publicPathã€‚

è¿˜æœ‰ä¸€äº›å…¶ä»–åŸå› å¯¼è‡´çš„å›¾ç‰‡åŠ è½½ä¸å‡ºæ¥ï¼Œæ•´ç†äº†ä¸‹é“¾æ¥ï¼Œæ”¾ä¸‹é¢ğŸ‘‡

è§£å†³å‚è€ƒï¼š[ä¸ºä»€ä¹ˆå¾®åº”ç”¨åŠ è½½çš„èµ„æºä¼š 404ï¼Ÿ](https://qiankun.umijs.org/zh/faq#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BE%AE%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD%E7%9A%84%E8%B5%84%E6%BA%90%E4%BC%9A-404)

[æ·»åŠ è‡ªå®šä¹‰ç¯å¢ƒå˜é‡](https://www.html.cn/create-react-app/docs/adding-custom-environment-variables/#%E5%9C%A8-env-%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F)

[å­åº”ç”¨çš„å›¾ç‰‡èµ„æºåŠ è½½ä¸å‡ºæ¥ #36](https://github.com/umijs/qiankun/issues/36)

[å­åº”ç”¨ä¸ºè€é¡¹ç›®ï¼Œç›¸å¯¹è·¯å¾„çš„å›¾ç‰‡åŠ è½½é—®é¢˜ #619](https://github.com/umijs/qiankun/issues/619)



## ä¸€äº›ç›¸å…³é“¾æ¥

[qiankunçš„reactå­é¡¹ç›®å¼•å…¥lessæ”¯æŒ](https://xudany.github.io/%E5%BE%AE%E5%89%8D%E7%AB%AF/2021/12/01/qiankun%E7%9A%84react%E5%AD%90%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5less%E6%94%AF%E6%8C%81/)

[qiankunçš„reactå­é¡¹ç›®å¼•å…¥antd](https://xudany.github.io/%E5%BE%AE%E5%89%8D%E7%AB%AF/2021/12/02/qiankun%E7%9A%84react%E5%AD%90%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5antd/)



## å‚è€ƒèµ„æ–™

[qiankun](https://qiankun.umijs.org/)

[qiankuné¡¹ç›®å®è·µå’Œä¼˜åŒ–(React+Vue)](https://bestofreactjs.com/repo/czero1995-qiankun)

[å¾®å‰ç«¯qiankunä»æ­å»ºåˆ°éƒ¨ç½²çš„å®è·µ](https://juejin.cn/post/6875462470593904653#heading-21)

[nextjså¾®æœåŠ¡åŸç†](https://zhuanlan.zhihu.com/p/362664179)